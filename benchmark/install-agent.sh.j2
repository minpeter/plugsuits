#!/bin/bash
set -e

echo "Installing system dependencies..."
# Use --no-install-recommends to minimize package size
# Required tools:
#   - curl, git, ca-certificates: for cloning and downloading
#   - unzip, tar: for extracting archives (bun install, ripgrep auto-download)
#   - ripgrep: for code search (faster than grep)
apt-get update -qq && apt-get install -y -qq --no-install-recommends \
  curl git ca-certificates unzip tar ripgrep \
  && rm -rf /var/lib/apt/lists/*

echo "Installing bun..."
curl -fsSL https://bun.sh/install | bash
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

echo "Cloning code-editing-agent..."
git clone --depth 1 --single-branch https://github.com/minpeter/code-editing-agent.git /agent
cd /agent

echo "Installing npm dependencies..."
# Use frozen lockfile for faster, reproducible installs
bun install --frozen-lockfile

echo "code-editing-agent installed successfully"
bun --version
